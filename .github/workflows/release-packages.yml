name: Release Packages

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package to publish"
        required: true
        type: choice
        default: all
        options:
          - all
          - ast
          - fuzzy-match
          - hashline-edit
          - lsp
          - mcp
          - web-search
      run_checks:
        description: "Run full validation before publish"
        required: true
        type: boolean
        default: true
      dry_run:
        description: "Do not publish to npm (npm publish --dry-run)"
        required: true
        type: boolean
        default: true
      create_tags:
        description: "Create and push git tags (<name>@<version>)"
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build.outputs.matrix }}
    steps:
      - id: build
        shell: bash
        run: |
          case "${{ inputs.package }}" in
            all)
              MATRIX='["ast","fuzzy-match","hashline-edit","lsp","mcp","web-search"]'
              ;;
            ast|fuzzy-match|hashline-edit|lsp|mcp|web-search)
              MATRIX='["${{ inputs.package }}"]'
              ;;
            *)
              echo "Unsupported package input: ${{ inputs.package }}" >&2
              exit 1
              ;;
          esac

          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  verify:
    runs-on: ubuntu-latest
    needs: plan
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
      - if: ${{ inputs.run_checks }}
        run: bun install
      - if: ${{ inputs.run_checks }}
        name: Ensure ast-grep binary
        run: |
          if ! node_modules/.bin/sg --version >/dev/null 2>&1; then
            rm -f node_modules/@ast-grep/cli/sg node_modules/@ast-grep/cli/ast-grep
            node node_modules/@ast-grep/cli/postinstall.js
          fi
          echo "$(pwd)/node_modules/.bin" >> $GITHUB_PATH
      - if: ${{ inputs.run_checks }}
        run: bun run deps:check
      - if: ${{ inputs.run_checks }}
        run: bun run check:ci
      - if: ${{ inputs.run_checks }}
        run: bun run test
      - if: ${{ inputs.run_checks }}
        run: bun run scorecard:check
      - if: ${{ inputs.run_checks }}
        run: bun run audit

  publish:
    runs-on: ubuntu-latest
    needs: [plan, verify]
    permissions:
      contents: write
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        pkg: ${{ fromJson(needs.plan.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: oven-sh/setup-bun@v1
      - name: Show Node/npm versions
        run: |
          node --version
          npm --version
      - run: bun install
      - name: Show package metadata
        working-directory: packages/${{ matrix.pkg }}
        run: |
          node -e 'const p=require("./package.json"); console.log(`${p.name}@${p.version}`)'
      - name: Package dry-run
        working-directory: packages/${{ matrix.pkg }}
        run: npm pack --dry-run
      - id: version_check
        name: Check if version is already published
        working-directory: packages/${{ matrix.pkg }}
        shell: bash
        run: |
          NAME=$(node -p "require('./package.json').name")
          VERSION=$(node -p "require('./package.json').version")
          REMOTE=$(npm view "$NAME" version --registry=https://registry.npmjs.org 2>/dev/null || true)

          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          if [ "$REMOTE" = "$VERSION" ]; then
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            echo "Skipping publish: $NAME@$VERSION already exists on npm"
          else
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
            if [ -z "$REMOTE" ]; then
              echo "Will publish new package/version: $NAME@$VERSION (no remote version found)"
            else
              echo "Will publish $NAME@$VERSION (latest remote: $REMOTE)"
            fi
          fi
      - name: Verify OIDC token availability
        if: ${{ steps.version_check.outputs.should_publish == 'true' }}
        shell: bash
        run: |
          if [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ] || [ -z "${ACTIONS_ID_TOKEN_REQUEST_TOKEN:-}" ]; then
            echo "OIDC token environment not available for this job."
            echo "Ensure workflow/job has 'permissions: id-token: write' and org/repo policy allows OIDC."
            exit 1
          fi
          echo "OIDC environment detected."
      - name: Publish (dry-run)
        if: ${{ inputs.dry_run && steps.version_check.outputs.should_publish == 'true' }}
        working-directory: packages/${{ matrix.pkg }}
        run: |
          unset NODE_AUTH_TOKEN
          unset NPM_CONFIG_USERCONFIG
          npm publish --dry-run --access public
      - name: Publish (npm trusted publisher via OIDC)
        if: ${{ !inputs.dry_run && steps.version_check.outputs.should_publish == 'true' }}
        working-directory: packages/${{ matrix.pkg }}
        run: |
          unset NODE_AUTH_TOKEN
          unset NPM_CONFIG_USERCONFIG
          npm publish --provenance --access public
      - name: Create and push tag
        if: ${{ !inputs.dry_run && inputs.create_tags && steps.version_check.outputs.should_publish == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NAME=$(node -p "require('./packages/${{ matrix.pkg }}/package.json').name")
          VERSION=$(node -p "require('./packages/${{ matrix.pkg }}/package.json').version")
          TAG="${NAME}@${VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "Tag $TAG already exists, skipping"
            exit 0
          fi

          git tag -a "$TAG" -m "$TAG"
          git push origin "$TAG"
