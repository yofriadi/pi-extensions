name: Release Packages (Git)

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package to release"
        required: true
        type: choice
        default: all
        options:
          - all
          - ast
          - commit
          - fuzzy-match
          - hashline-edit
          - lsp
          - mcp
          - review
          - web-search
      run_checks:
        description: "Run full validation before release"
        required: true
        type: boolean
        default: true
      dry_run:
        description: "Do not push tags or create GitHub releases"
        required: true
        type: boolean
        default: true
      create_tags:
        description: "Create and push git tags"
        required: true
        type: boolean
        default: true
      create_releases:
        description: "Create GitHub release and upload tarballs"
        required: true
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build.outputs.matrix }}
    steps:
      - id: build
        shell: bash
        run: |
          case "${{ inputs.package }}" in
            all)
              MATRIX='["ast","commit","fuzzy-match","hashline-edit","lsp","mcp","review","web-search"]'
              ;;
            ast|commit|fuzzy-match|hashline-edit|lsp|mcp|review|web-search)
              MATRIX='["${{ inputs.package }}"]'
              ;;
            *)
              echo "Unsupported package input: ${{ inputs.package }}" >&2
              exit 1
              ;;
          esac

          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  verify:
    runs-on: ubuntu-latest
    needs: plan
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
      - if: ${{ inputs.run_checks }}
        run: bun install
      - if: ${{ inputs.run_checks }}
        name: Ensure ast-grep binary
        run: |
          if ! node_modules/.bin/sg --version >/dev/null 2>&1; then
            rm -f node_modules/@ast-grep/cli/sg node_modules/@ast-grep/cli/ast-grep
            node node_modules/@ast-grep/cli/postinstall.js
          fi
          echo "$(pwd)/node_modules/.bin" >> $GITHUB_PATH
      - if: ${{ inputs.run_checks }}
        run: bun run deps:check
      - if: ${{ inputs.run_checks }}
        run: bun run check:ci
      - if: ${{ inputs.run_checks }}
        run: bun run test
      - if: ${{ inputs.run_checks }}
        run: bun run scorecard:check
      - if: ${{ inputs.run_checks }}
        run: bun run audit

  release:
    runs-on: ubuntu-latest
    needs: [plan, verify]
    strategy:
      fail-fast: false
      matrix:
        pkg: ${{ fromJson(needs.plan.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v1

      - run: bun install

      - id: metadata
        name: Compute package metadata
        shell: bash
        run: |
          PKG_DIR="packages/${{ matrix.pkg }}"
          NAME=$(node -p "require('./${PKG_DIR}/package.json').name")
          VERSION=$(node -p "require('./${PKG_DIR}/package.json').version")
          RELEASE_TAG="${NAME}@${VERSION}"
          GIT_TAG="${{ matrix.pkg }}-v${VERSION}"
          ASSET_BASE="${{ matrix.pkg }}-${VERSION}"

          echo "pkg_dir=$PKG_DIR" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          echo "git_tag=$GIT_TAG" >> "$GITHUB_OUTPUT"
          echo "asset_base=$ASSET_BASE" >> "$GITHUB_OUTPUT"

          echo "Preparing release for $NAME@$VERSION"
          echo "Git tag: $GIT_TAG"

      - id: package
        name: Build git release tarball
        shell: bash
        run: |
          OUT_DIR="$RUNNER_TEMP/dist"
          mkdir -p "$OUT_DIR"

          TAR_PATH="$OUT_DIR/${{ steps.metadata.outputs.asset_base }}.tar.gz"
          SHA_PATH="$OUT_DIR/${{ steps.metadata.outputs.asset_base }}.sha256"

          git archive \
            --format=tar.gz \
            --prefix="${{ steps.metadata.outputs.asset_base }}/" \
            -o "$TAR_PATH" \
            "HEAD:${{ steps.metadata.outputs.pkg_dir }}"

          sha256sum "$TAR_PATH" > "$SHA_PATH"

          echo "tar_path=$TAR_PATH" >> "$GITHUB_OUTPUT"
          echo "sha_path=$SHA_PATH" >> "$GITHUB_OUTPUT"

          echo "Created artifacts:"
          ls -lh "$TAR_PATH" "$SHA_PATH"

      - id: tag_check
        name: Check if git tag already exists
        shell: bash
        run: |
          if git rev-parse -q --verify "refs/tags/${{ steps.metadata.outputs.git_tag }}" >/dev/null; then
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
            echo "Tag already exists: ${{ steps.metadata.outputs.git_tag }}"
          else
            echo "tag_exists=false" >> "$GITHUB_OUTPUT"
            echo "Tag does not exist yet: ${{ steps.metadata.outputs.git_tag }}"
          fi

      - name: Dry-run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "DRY RUN"
          echo "Package: ${{ steps.metadata.outputs.name }}"
          echo "Version: ${{ steps.metadata.outputs.version }}"
          echo "Git tag: ${{ steps.metadata.outputs.git_tag }}"
          echo "Release tag/title: ${{ steps.metadata.outputs.release_tag }}"
          echo "Tarball: ${{ steps.metadata.outputs.asset_base }}.tar.gz"

      - name: Create and push git tag
        if: ${{ !inputs.dry_run && inputs.create_tags && steps.tag_check.outputs.tag_exists == 'false' }}
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git tag -a "${{ steps.metadata.outputs.git_tag }}" -m "${{ steps.metadata.outputs.release_tag }}"
          git push origin "${{ steps.metadata.outputs.git_tag }}"

      - name: Create or update GitHub release
        if: ${{ !inputs.dry_run && inputs.create_releases }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          TAG="${{ steps.metadata.outputs.git_tag }}"
          TITLE="${{ steps.metadata.outputs.release_tag }}"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release already exists for $TAG, updating assets"
          else
            gh release create "$TAG" \
              --title "$TITLE" \
              --notes "Git distribution release for $TITLE"
          fi

          gh release upload "$TAG" \
            "${{ steps.package.outputs.tar_path }}" \
            "${{ steps.package.outputs.sha_path }}" \
            --clobber
